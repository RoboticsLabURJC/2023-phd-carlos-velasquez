---
title: Week 74 -  Balanceo estratificado (train, test offline y online)
categories:
    - weekly Log
tags:
    - CARLA Simulator
    - Python
    - DAgger
    - Teleoperado
---

### Balanceo del Dataset, Segmentación y Entrenamiento de Modelos DL

Con el objetivo de mejorar el desempeño en conducción autónoma dentro del simulador CARLA, se rediseñó completamente el proceso de dataset y entrenamiento.

#### Estratificación y Balanceo 5×4 (Steer–Throttle)

Para evitar que el modelo aprendiera sesgos a conducir recto o a acelerar siempre al máximo, se definió una estratificación basada en:

| Variable                   | Clases | Descripción                       |
| -------------------------- | -----: | --------------------------------- |
| Ángulo de giro (**steer**) |      5 | Fuerte izquierda → Fuerte derecha |
| Aceleración (**throttle**) |      4 | Muy lento → Muy rápido            |

> Total: 20 clases combinadas (5×4)

Se pasó de un dataset sin procesar de ~95 000 imágenes a un dataset balanceado de ~45 000 imágenes, con igual proporción de muestras en cada clase.

El dataset final se dividió en:

| Conjunto                | Porcentaje |
| ----------------------- | ---------: |
| Train + Validation      |        85% |
| Test (offline)          |        15% |
| Split interno Train/Val |      80/20 |

Preprocesamiento de Imágenes
Segmentación → Recorte → Normalización → Augmentations

Las imágenes utilizadas para entrenar los modelos fueron exclusivamente segmentadas, permitiendo que el modelo se enfoque únicamente en la geometría de la carretera:

* Se utilizó el canal de segmentación de CARLA
* Se extrajo la clase calzada
* Se generó una máscara binaria:

  * Calzada → blanco [255,255,255]
  * Resto → negro [0,0,0]

- Eliminando totalmente edificios, cielo, vehículos y peatones
- Reduciendo el ruido visual y acelerando el aprendizaje del modelo

Además:

* Se realizó un recorte del ~40% de la parte superior de la imagen (solo se dejó la zona relevante para la conducción)

*Se aplicaron augmentations de Albumentations para robustez:

RandomBrightnessContrast

* Affine
* MotionBlur
* GaussianBlur
* GaussNoise
* Normalización

#### Visualización del Balanceo

Se observa una distribución uniforme después del balanceo, asegurando que el modelo reciba experiencias variadas equitativamente.

<figure class="half">
  <img src="{{ site.url }}{{ site.baseurl }}/assets/images/week74/balanceo.png"
       alt="EfficientNetV2-S – trayectoria con BehaviorMetrics"
       style="width:90%">
  <figcaption>Figura — Distribución 3D de Steer vs Throttle (antes vs después del balanceo)</figcaption>
</figure>

#### Resultados Offline

| Modelo                 | Steer RMSE ↓ |  Steer MAE ↓ | Throttle RMSE ↓ | Throttle MAE ↓ |
| ---------------------- | -----------: | -----------: | --------------: | -------------: |
| **PilotNet**           |       0.2429 |       0.1297 |          0.2861 |         0.1817 |
| **MobileNet V3-Small** |       0.2491 |       0.1691 |          0.2647 |         0.2077 |
| **EfficientNet V2-S**  |       0.1761 |       0.1091 |          0.2092 |         0.1446 |
| **ResNet18**           |   **0.1661** |   **0.0990** |      **0.1955** |     **0.1314** |

> * Se logró una mejora significativa en la predicción del control
> *ResNet18 resultó ser el modelo más efectivo

#### Comportamiento Online

Se observó un leve zig-zag en conducción autónoma real.
Esto está asociado al ruido humano en el dataset:
>La conducción fue registrada con un joystick de PS4, lo cual dificulta movimientos suaves y precisos.

Esto introduce una oscilación ligera pero persistente en la inferencia online.

#### Nueva tabla global comparativa por modelo

(Valores antiguos vs nuevos, mostrando deterioro relativo en Throttle/Steer)

| Modelo                 | Steer RMSE ↑ | Steer MAE ↑ | Throttle RMSE ↑ | Throttle MAE ↑ |
| ---------------------- | -----------: | ----------: | --------------: | -------------: |
| **ResNet18**           |       +82.9% |      +49.4% |          +99.3% |         +86.4% |
| **EfficientNet V2-S**  |      −45.4%  |      −56.2% |          −46.4% |         −58.1% |
| **MobileNet V3-Small** |       −36.2% |      −51.1% |          −32.2% |         −39.9% |
| **PilotNet**           |       −11.3% |      −34.1% |          −28.9% |         −48.1% |

> El nuevo dataset balanceado basado en segmentación binaria mejora significativamente la estabilidad del control online y reduce el sesgo hacia conducción recta. En métricas offline, los modelos EfficientNet-V2-S, MobileNetV3-Small y PilotNet muestran una mejora relativa entre 30% y 58% con respecto al dataset original en todas las métricas. 

> En la práctica online todavía se observa zig-zag derivado de ruido humano en la recolección de datos, por lo cual se propone reemplazar el joystick por un volante real, mejorar la naturaleza de la conducción teleoperada y fusionar RGB + segmentación para mayor anticipación a curvas.


#### Próximos pasos
| Acción                                 | Objetivo                                  |
| -------------------------------------- | ----------------------------------------- |
| RGB + máscara (4 canales)              | Mejor anticipación y estabilidad          |
| Recopilar dataset con **volante real** | Reducir ruido del steer humano            |
| Balanceo suave (no total)              | Mantener priorización natural del dataset |
| Pruebas en BehaviorMetrics (ROS2)      | Métricas reales de navegación             |


### Test online (Efficientnet_v2_s, Town02)

<iframe width="1381" height="777" src="https://www.youtube.com/embed/As6ZFbhOWBo" title="Efficientnet_v2_s Driving Test – CARLA Town02" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

Efficientnet_v2_s Driving Test – CARLA Town02